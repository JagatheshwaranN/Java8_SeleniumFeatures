package concepts.pen;

import org.openqa.selenium.By;
import org.openqa.selenium.Rectangle;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.interactions.Actions;
import org.openqa.selenium.interactions.PointerInput;
import org.testng.Assert;
import org.testng.annotations.AfterMethod;
import org.testng.annotations.BeforeMethod;
import org.testng.annotations.Test;
import scenarios.DriverConfiguration;

import java.util.Arrays;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

public class PenTest {

    // Declare a WebDriver instance to interact with the web browser.
    private WebDriver driver;

    @BeforeMethod
    public void setUp() {
        // Set up the WebDriver instance by calling a method named 'browserSetup' from the 'DriverConfiguration' class
        driver = DriverConfiguration.browserSetup();
    }

    @AfterMethod
    public void tearDown() {
        // Check if the 'driver' variable is not null, indicating that a WebDriver instance exists.
        if (driver != null) {
            // If a WebDriver instance exists, quit/close the browser session.
            driver.quit();
        }
    }

    @Test
    public void testPen() {
        // Navigate to the specific page
        driver.get("https://www.selenium.dev/selenium/web/pointerActionsPage.html");

        // Find the pointer area element on the page
        WebElement pointerArea = driver.findElement(By.id("pointerArea"));

        // Perform a series of actions using the Actions class to simulate pen input
        new Actions(driver)
                // Set the active pointer to a pen with the name "default pen"
                .setActivePointer(PointerInput.Kind.PEN, "default pen")
                // Move the pen to the center of the pointer area
                .moveToElement(pointerArea)
                // Click and hold the pen
                .clickAndHold()
                // Move the pen by 2 pixels to the right and 2 pixels down
                .moveByOffset(2, 2)
                // Release the pen
                .release()
                // Perform all queued actions
                .perform();

        // Find elements representing various pointer actions (move, down, up)
        List<WebElement> moves = driver.findElements(By.className("pointermove"));
        Map<String, String> moveTo = getPropertyInfo(moves.get(0));
        Map<String, String> down = getPropertyInfo(driver.findElement(By.className("pointerdown")));
        Map<String, String> moveBy = getPropertyInfo(moves.get(1));
        Map<String, String> up = getPropertyInfo(driver.findElement(By.className("pointerup")));

        // Get the rectangle information of the pointer area
        Rectangle rectangle = pointerArea.getRect();

        // Calculate the center of the pointer area
        int centerXAxis = (int) (double) (rectangle.width / 2 + rectangle.getX());
        int centerYAxis = (int) (double) (rectangle.height / 2 + rectangle.getY());

        // Assertions to validate the properties of pointer actions
        Assert.assertEquals("-1", moveTo.get("button"));
        Assert.assertEquals("pen", moveTo.get("pointerType"));
        Assert.assertEquals(String.valueOf(centerXAxis), moveTo.get("pageX"));
        Assert.assertEquals(String.valueOf(centerYAxis), moveTo.get("pageY"));
        Assert.assertEquals("0", down.get("button"));
        Assert.assertEquals("pen", down.get("pointerType"));
        Assert.assertEquals(String.valueOf(centerXAxis), down.get("pageX"));
        Assert.assertEquals(String.valueOf(centerYAxis), down.get("pageY"));
        Assert.assertEquals("-1", moveBy.get("button"));
        Assert.assertEquals("pen", moveBy.get("pointerType"));
        Assert.assertEquals(String.valueOf(centerXAxis + 2), moveBy.get("pageX"));
        Assert.assertEquals(String.valueOf(centerYAxis + 2), moveBy.get("pageY"));
        Assert.assertEquals("0", up.get("button"));
        Assert.assertEquals("pen", up.get("pointerType"));
        Assert.assertEquals(String.valueOf(centerXAxis + 2), up.get("pageX"));
        Assert.assertEquals(String.valueOf(centerYAxis + 2), up.get("pageY"));
    }

    // Method to extract properties from a WebElement representing a pointer action
    private Map<String, String> getPropertyInfo(WebElement element) {
        // Get the text content of the WebElement
        String text = element.getText();

        // Extract property information by removing the initial identifier
        text = text.substring(text.indexOf(' ') + 1);

        // Split the text by "," to separate key-value pairs
        return Arrays.stream(text.split(", "))
                // Split each pair by ":" to separate keys and values
                .map(t -> t.split(": "))
                // Collect the split pairs into a Map<String, String>
                .collect(Collectors.toMap(c -> c[0], c -> c[1]));
    }

}
